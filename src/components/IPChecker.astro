---
interface Props {
  enableProtection?: boolean;
}

const { enableProtection = true } = Astro.props;
---

{enableProtection && (
  <script>
    (function() {
      // 安全的localStorage操作
      function safeLocalStorageGet(key: string): string | null {
        try {
          if (typeof key !== 'string' || key.length === 0) {
            return null;
          }
          return localStorage.getItem(key);
        } catch (e) {
          console.error('localStorage读取失败:', e);
          return null;
        }
      }

      function safeLocalStorageSet(key: string, value: string): boolean {
        try {
          if (typeof key !== 'string' || key.length === 0) {
            return false;
          }
          if (value === undefined || value === null) {
            return false;
          }
          localStorage.setItem(key, value);
          return true;
        } catch (e) {
          console.error('localStorage存储失败:', e);
          return false;
        }
      }

      // 加密函数
      function encrypt(data: any): string | null {
        try {
          return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        } catch (e) {
          console.error('加密失败:', e);
          return null;
        }
      }

      // 解密函数
      function decrypt(encryptedData: string): any | null {
        try {
          return JSON.parse(decodeURIComponent(escape(atob(encryptedData))));
        } catch (e) {
          console.error('解密失败:', e);
          return null;
        }
      }

      // 获取存储的数据
      function getData(key: string): any | null {
        try {
          const encrypted = safeLocalStorageGet(key);
          if (!encrypted) {
            return null;
          }
          return decrypt(encrypted);
        } catch (e) {
          console.error('获取数据失败:', e);
          return null;
        }
      }

      // 存储数据
      function setData(key: string, data: any): boolean {
        try {
          const encrypted = encrypt(data);
          if (!encrypted) {
            return false;
          }
          return safeLocalStorageSet(key, encrypted);
        } catch (e) {
          console.error('存储数据失败:', e);
          return false;
        }
      }

      // 安全的重定向函数
      function safeRedirect(url: string): boolean {
        try {
          if (typeof url !== 'string' || url.length === 0) {
            return false;
          }
          if (!url.startsWith('/') && !url.startsWith('http://') && !url.startsWith('https://')) {
            return false;
          }
          window.location.replace(url);
          return true;
        } catch (e) {
          console.error('重定向失败:', e);
          return false;
        }
      }

      // 配置
      const CONFIG = {
        IP_API: 'https://ip.cn/',
        STORAGE_KEY: 'ip_checker_data',
        BLOCK_PAGE: '/lj/',
        MAX_REQUESTS: 5,
        WINDOW_SECONDS: 10,
        BLOCK_SECONDS: 15,
        BLACKLIST_KEY: 'ip_blacklist'
      };

      // 获取当前IP和地址
      async function getIPInfo(): Promise<{ ip: string; location: string }> {
        try {
          const response = await fetch(CONFIG.IP_API);
          if (!response.ok) {
            throw new Error('API请求失败');
          }
          const text = await response.text();
          
          // 解析HTML获取IP和地址信息
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          
          // 提取IP地址 - 根据实际页面结构
          const ipElements = doc.querySelectorAll('p');
          let ip = '未知';
          let location = '未知';
          
          ipElements.forEach((element) => {
            if (element.textContent?.includes('您现在的IP')) {
              // IP地址在当前元素的下一个兄弟元素中
              const nextElement = element.nextElementSibling;
              if (nextElement) {
                ip = nextElement.textContent.trim();
              }
            } else if (element.textContent?.includes('所在地理位置')) {
              // 地理位置在当前元素的下一个兄弟元素中
              const nextElement = element.nextElementSibling;
              if (nextElement) {
                location = nextElement.textContent.trim();
              }
            }
          });
          
          return { ip, location };
        } catch (e) {
          console.error('获取IP信息失败:', e);
          return { ip: '未知', location: '未知' };
        }
      }

      // 检查IP是否在黑名单中
      function isIPBlacklisted(ip: string): boolean {
        try {
          const blacklistData = safeLocalStorageGet(CONFIG.BLACKLIST_KEY);
          if (!blacklistData) {
            return false;
          }
          const blacklist = JSON.parse(blacklistData);
          return Array.isArray(blacklist) && blacklist.includes(ip);
        } catch (e) {
          console.error('检查黑名单失败:', e);
          return false;
        }
      }

      // 添加IP到黑名单
      function addIPToBlacklist(ip: string): void {
        try {
          let blacklist: string[] = [];
          const blacklistData = safeLocalStorageGet(CONFIG.BLACKLIST_KEY);
          if (blacklistData) {
            blacklist = JSON.parse(blacklistData);
            if (!Array.isArray(blacklist)) {
              blacklist = [];
            }
          }
          if (!blacklist.includes(ip)) {
            blacklist.push(ip);
            safeLocalStorageSet(CONFIG.BLACKLIST_KEY, JSON.stringify(blacklist));
          }
        } catch (e) {
          console.error('添加黑名单失败:', e);
        }
      }

      // 主函数
      async function ipChecker(): Promise<void> {
        try {
          // 获取当前IP信息
          const ipInfo = await getIPInfo();
          
          // 存储IP信息到localStorage，供封锁页面使用
          safeLocalStorageSet('current_ip_info', JSON.stringify(ipInfo));
          
          // 检查IP是否在黑名单中
          if (isIPBlacklisted(ipInfo.ip)) {
            // 在黑名单中，直接重定向到封锁页面
            safeRedirect(CONFIG.BLOCK_PAGE);
            return;
          }

          // 获取存储的访问数据
          let accessData = getData(CONFIG.STORAGE_KEY);
          
          if (!accessData) {
            // 首次访问，初始化数据
            accessData = {
              requests: [],
              blockedUntil: 0,
              ips: {}
            };
          }

          // 检查是否被封锁
          const now = Date.now();
          const nowSeconds = Math.floor(now / 1000);
          
          if (accessData.blockedUntil && nowSeconds < accessData.blockedUntil) {
            // 被封锁，重定向到封锁页面
            safeRedirect(CONFIG.BLOCK_PAGE);
            return;
          }

          // 解除封锁状态
          if (accessData.blockedUntil && accessData.blockedUntil > 0 && nowSeconds >= accessData.blockedUntil) {
            accessData.blockedUntil = 0;
            accessData.requests = [];
            accessData.ips = {};
          }

          // 清理过期的请求记录
          accessData.requests = accessData.requests.filter((timestamp: number) => {
            return timestamp && nowSeconds - timestamp < CONFIG.WINDOW_SECONDS;
          });

          // 处理IP访问记录
          if (!accessData.ips) {
            accessData.ips = {};
          }
          
          // 更新当前IP的访问记录
          if (!accessData.ips[ipInfo.ip]) {
            accessData.ips[ipInfo.ip] = [];
          }
          
          // 清理当前IP的过期记录
          accessData.ips[ipInfo.ip] = accessData.ips[ipInfo.ip].filter((timestamp: number) => {
            return timestamp && nowSeconds - timestamp < CONFIG.WINDOW_SECONDS;
          });

          // 添加当前请求记录
          accessData.requests.push(nowSeconds);
          accessData.ips[ipInfo.ip].push(nowSeconds);

          // 检查是否超过最大请求次数
          // 检查同一IP的请求次数
          const ipRequestCount = accessData.ips[ipInfo.ip].length;
          // 检查同一时间不同IP的请求次数（IP数量）
          const uniqueIPs = Object.keys(accessData.ips).length;

          // 如果同一IP请求过多或同一时间不同IP请求过多，触发封禁
          if (ipRequestCount > CONFIG.MAX_REQUESTS || uniqueIPs > 3) {
            // 超过限制，设置封锁
            accessData.blockedUntil = nowSeconds + CONFIG.BLOCK_SECONDS;
            
            // 连续访问多次，加入黑名单
            if (ipRequestCount > 10) {
              addIPToBlacklist(ipInfo.ip);
            }
            
            // 存储更新后的数据
            setData(CONFIG.STORAGE_KEY, accessData);
            
            // 重定向到封锁页面
            safeRedirect(CONFIG.BLOCK_PAGE);
          } else {
            // 存储更新后的数据
            setData(CONFIG.STORAGE_KEY, accessData);
          }
        } catch (e) {
          console.error('IPChecker执行失败:', e);
          // 即使出错，也确保系统不会崩溃
        }
      }

      // 初始化
      ipChecker();
    })();
  </script>
)}
