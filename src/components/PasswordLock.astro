---
// PasswordLock.astro
interface Props {
  encryptedData: string;
  hash: string; // å¯†ç çš„ MD5 æˆ–ç®€æ˜“å“ˆå¸Œï¼Œç”¨äºæ ¡éªŒ
}
const { encryptedData, hash } = Astro.props;
---

<div id="lock-container" class="my-4 p-6 border-2 border-dashed border-gray-300 rounded-xl text-center" data-encrypted="{encryptedData}">
  <div id="password-form">
    <h3 class="text-lg font-bold mb-4">ğŸ”’ æ­¤å†…å®¹å·²åŠ å¯†</h3>
    <input 
      type="password" 
      id="page-password" 
      placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " 
      class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <button 
      id="unlock-btn" 
      class="ml-2 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition"
    >
      è§£å¯†
    </button>
    <p id="error-msg" class="text-red-500 mt-2 hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
  </div>

  <div id="decrypted-content" class="hidden text-left">
    </div>
</div>

<script>
  import CryptoJS from 'crypto-js';

  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('lock-container');
    if (!container) return;
    
    const btn = container.querySelector('#unlock-btn');
    const input = container.querySelector('#page-password');
    const errorMsg = container.querySelector('#error-msg');
    const contentDiv = container.querySelector('#decrypted-content');
    const formDiv = container.querySelector('#password-form');

    // ä»æ•°æ®å±æ€§ä¸­è·å–åŠ å¯†æ•°æ®
    const encrypted = container.getAttribute('data-encrypted');
    if (!encrypted) return;

    btn?.addEventListener('click', () => {
      if (!input) return;
      const password = input.value;
      try {
        const bytes = CryptoJS.AES.decrypt(encrypted, password);
        const originalText = bytes.toString(CryptoJS.enc.Utf8);

        if (originalText.length > 0) {
          if (contentDiv) {
            contentDiv.innerHTML = originalText;
            contentDiv.classList.remove('hidden');
          }
          formDiv?.classList.add('hidden');
        } else {
          errorMsg?.classList.remove('hidden');
        }
      } catch (e) {
        errorMsg?.classList.remove('hidden');
      }
    });
  });
</script>
